name: E2E Tests legacy

on:
    workflow_call:

jobs:
    php-e2e-tests-shopware-5-7:
        name: Shopware 5.2
        runs-on: ubuntu-latest

        env:
            GH_TOKEN: ${{ github.token }}
            DB_USER: root
            DB_PASSWORD: root
            DB_HOST: 127.0.0.1
            DB_PORT: 3306
            DB_NAME: shopware
            SW_HOST: 127.0.0.1:8080
            SW_BASE_PATH: ""
            SELENIUM_HOST: selenium
            ELASTICSEARCH_HOST: elasticsearch

            PAYPAL_SANDBOX_CLIENT_ID: ${{ secrets.PAYPAL_SANDBOX_CLIENT_ID_LEGACY }}
            PAYPAL_SANDBOX_CLIENT_SECRET: ${{ secrets.PAYPAL_SANDBOX_CLIENT_SECRET_LEGACY }}
            PAYPAL_SANDBOX_MERCHANT_ID: ${{ secrets.PAYPAL_SANDBOX_MERCHANT_ID_LEGACY }}

            PAYPAL_CUSTOMER_EMAIL: ${{ secrets.PAYPAL_CUSTOMER_EMAIL }}
            PAYPAL_CUSTOMER_PASSWORD: ${{ secrets.PAYPAL_CUSTOMER_PASSWORD }}
            PAYPAL_CREDIT_CARD: ${{ secrets.PAYPAL_CREDIT_CARD }}

            PAYPAL_SEPA_IBAN: ${{ secrets.PAYPAL_SEPA_IBAN }}
            PAYPAL_SEPA_PHONE: ${{ secrets.PAYPAL_SEPA_PHONE }}
            PAYPAL_SEPA_BIRTHDAY: ${{ secrets.PAYPAL_SEPA_BIRTHDAY }}

        steps:
            -   name: Checkout Shopware
                uses: actions/checkout@v3
                with:
                    repository: shopware/shopware
                    path: shopware
                    ref: '5.2'

            -   name: Checkout SwagPaymentPayPalUnified
                uses: actions/checkout@v3
                with:
                    path: shopware/custom/plugins/SwagPaymentPayPalUnified

            -   name: Checkout SwagCookieConsentManager
                uses: actions/checkout@v3
                with:
                    repository: shopware5/SwagCookieConsentManager
                    path: shopware/custom/plugins/SwagCookieConsentManager
                    ref: '5.2.11-5.2.27'

            -   name: Setup Mysql
                uses: shogo82148/actions-setup-mysql@v1
                with:
                    mysql-version: '5.7'
                    root-password: 'root'
            -   run: mysql -uroot -proot -h127.0.0.1 -e 'SELECT version()'

            -   name: Setup PHP
                uses: shivammathur/setup-php@v2
                with:
                    php-version: '5.6'

            -   name: Setup Apache
                uses: thunder/apache-shiva-php-action@v1
                with:
                    php-version: '5.6'
                    site-directory: ${{ github.workspace }}/shopware
                    http-port: 8080

            -   name: Prepare Shopware config.php
                run: |
                    yes | cp shopware/custom/plugins/SwagPaymentPayPalUnified/.github/config.php shopware/config.php
                    sed -i "s/__DB_USER__/${DB_USER}/g" shopware/config.php
                    sed -i "s/__DB_PASSWORD__/${DB_PASSWORD}/g" shopware/config.php
                    sed -i "s/__DB_NAME__/${DB_NAME}/g" shopware/config.php
                    sed -i "s/__DB_HOST__/${DB_HOST}/g" shopware/config.php
                    sed -i "s/__DB_PORT__/${DB_PORT}/g" shopware/config.php

            -   name: Setup Shopware
                run: |
                    cd shopware
                    composer install
                    php bin/console sw:database:setup --steps=drop,create,import,importDemodata
                    php bin/console sw:cache:clear
                    php bin/console sw:database:setup --steps=setupShop --shop-url=http://${SW_HOST}${SW_BASE_PATH}
                    php bin/console sw:snippets:to:db --include-plugins
                    php bin/console sw:theme:initialize
                    php bin/console sw:firstrunwizard:disable
                    php bin/console sw:admin:create --name="Demo" --email="demo@demo.de" --username="demo" --password="demo" --locale=de_DE -n
                    touch recovery/install/data/install.lock

            -   name: Setup SwagCookieConsentManager
                run: |
                    cd shopware
                    php bin/console sw:plugin:refresh
                    php bin/console sw:plugin:install SwagCookieConsentManager --activate
                    php bin/console sw:cache:clear

            -   name: Setup SwagPaymentPayPalUnified
                run: |
                    cd shopware/custom/plugins/SwagPaymentPayPalUnified
                    make composer-install
                    make install-plugin-legacy
                    cd Tests/E2E
                    npm install
                    npx playwright install --with-deps chromium

            -   name: Execute E2E tests
                run: |
                    cd shopware/custom/plugins/SwagPaymentPayPalUnified
                    make run-e2e-tests

            -   name: Upload artifacts
                uses: actions/upload-artifact@v3
                if: ${{ failure() }}
                with:
                    name: E2E test results
                    path: shopware/custom/plugins/SwagPaymentPayPalUnified/Tests/E2E/results
